name: Generate image from last commit

permissions:
  contents: write
  pages: write

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  generate-image:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get last commit
        run: |
          last_commit=$(git log -1 --pretty=format:"%h %s")

      - name: Generate image
        run: |
          response=$(curl -d "{\"params\":[{\"name\":\"text1\",\"text\":\"$last_commit\",\"color\":\"#333\",\"backgroundColor\":\"#f9f9f9\",\"borderColor\":\"#ddd\",\"borderWidth\":\"1px\",\"borderRadius\":\"5px\",\"opacity\":1}]}" \
            -H "Authorization: Bearer ${{ secrets.API_KEY }}" \
            -H "Content-Type: application/json" \
            -X POST https://api.dynapictures.com/designs/7f6476af6a)
          imageUrl=$(echo $response | jq -r '.imageUrl')
          timestamp=$(date +%Y%m%d%H%M%S)
          mkdir -p images
          curl -o images/image_$timestamp.png $imageUrl

      - name: Upload images as artifact
        uses: actions/upload-artifact@v4
        with:
          name: images
          path: ./images/

  build-site:
    runs-on: ubuntu-latest
    needs: generate-image
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Generate HTML page
        run: python generate_html.py

      - name: Deploy to prod
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./