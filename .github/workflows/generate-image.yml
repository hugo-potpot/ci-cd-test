name: Generate image from last commit

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  get-last-commit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get last commit
        run: |
          last_commit=$(git log -1 --pretty=format:"%h %s")

      - name: Generate image
        run: |
          response=$(curl -d "{\"params\":[{\"name\":\"text1\",\"text\":\"$last_commit\",\"color\":\"#333\",\"backgroundColor\":\"#f9f9f9\",\"borderColor\":\"#ddd\",\"borderWidth\":\"1px\",\"borderRadius\":\"5px\",\"opacity\":1}]}" \
            -H "Authorization: Bearer ${{ secrets.API_KEY }}" \
            -H "Content-Type: application/json" \
            -X POST https://api.dynapictures.com/designs/7f6476af6a)
          echo "Response: $response"
          imageUrl=$(echo $response | jq -r '.imageUrl')
          timestamp=$(date +%Y%m%d%H%M%S)
          mkdir images
          curl -o images/image_$timestamp.png $imageUrl

      - name: Save image as artifact
        uses: actions/upload-artifact@v4
        with:
          name: generated-image
          path: images/image_*.png